# 批量SPR对齐+信号提取功能集成说明

## 概述

已成功将 `batch_imgs_process4.py` 的批量SPR对齐+信号提取功能集成到UI界面中。用户现在可以通过图形界面轻松执行批量图像处理任务。

## 新增文件

1. **ui/batch_thread.py** - 批量处理线程类
   - 在后台执行批量处理任务
   - 发送进度信息到UI
   - 处理错误和完成信号

2. **ui/batch_config_dialog.py** - 批量处理配置对话框
   - 提供图形化参数配置界面
   - 支持选择输入目录、掩膜文件、保存目录
   - 可配置处理选项（强制重新对齐、输出对齐图像等）

3. **ui/README_批量处理集成.md** - 本文档

## 修改的文件

**ui/main.py** - 主界面
- 添加了批量处理菜单项
- 添加了批量处理工具栏按钮
- 实现了批量处理相关的方法

## 功能特性

### 1. 用户界面入口

- **菜单栏**: 文件 → 批量SPR处理
- **工具栏**: 右侧工具栏底部的"批量SPR处理"按钮

### 2. 配置选项

配置对话框提供以下选项：

#### 路径配置
- **输入目录**: 包含图像序列的文件夹
- **掩膜文件**: .npy格式的掩膜文件
- **保存目录**: 结果保存位置

#### 处理选项
- **强制重新对齐**: 重新计算图像对齐（忽略已有结果）
- **输出对齐图像**: 保存对齐+裁剪后的图像用于核验
- **强制重新计算**: 忽略进度CSV，重新计算全部帧
- **启用背景ROI**: 可以选择背景区域
- **工作线程数**: 并行处理的线程数（默认为CPU核心数的一半）

### 3. 处理流程

1. 点击"批量SPR处理"按钮或菜单项
2. 在配置对话框中设置参数
3. 点击"开始处理"
4. 实时查看处理进度和日志
5. 处理完成后查看结果摘要

### 4. 输出结果

- **Excel文件**: 包含Mean Signal、Variance Signal、Combined Signal和Meta Info四个工作表
- **进度CSV**: 记录每帧的处理进度，支持断点续运行
- **对齐图像**（可选）: 对齐+裁剪后的图像序列
- **调试图像**: alignment_shifts.csv 和调试可视化图像

## 使用示例

### 基本使用流程

```python
# 1. 启动应用
python ui/main.py

# 2. 在UI中操作：
#    - 点击菜单: 文件 → 批量SPR处理
#    - 或点击工具栏的批量处理按钮

# 3. 在配置对话框中：
#    - 选择输入目录（包含图像序列）
#    - 选择掩膜文件（.npy格式）
#    - 选择保存目录
#    - 根据需要调整处理选项

# 4. 点击"开始处理"并等待完成

# 5. 查看结果：
#    - Excel文件包含所有信号数据
#    - 进度CSV记录详细的处理信息
```

### 后台处理机制

批量处理使用独立线程执行，不会阻塞UI界面：

- **实时进度**: 处理过程中会在信息框显示实时进度
- **错误处理**: 如果出错会显示详细错误信息
- **结果通知**: 完成后弹出对话框显示结果摘要

## 技术实现

### 线程架构

```
MainWindow (UI主线程)
    └── BatchProcessThread (批量处理线程)
            ├── Stage A: 图像对齐
            │   ├── 稀疏黑点掩膜检测
            │   ├── 局部爬山优化
            │   └── 计算公共裁剪框
            └── Stage B: 信号提取
                ├── 在线移位+裁剪
                ├── (R-G) 残差计算
                └── 保存到Excel
```

### 信号通信

- **progress_signal**: 发送进度信息到UI
- **finished_signal**: 发送完成信号和结果信息
- **error_signal**: 发送错误信息

## 注意事项

1. **内存占用**: 处理大量图像时会占用较多内存，建议根据系统配置调整工作线程数

2. **进度恢复**: 如果处理中断，再次运行会自动从上次的进度继续（除非勾选"强制重新计算"）

3. **背景ROI选择**: 如果启用背景ROI，在开始处理时会弹出窗口让你选择背景区域：
   - 拖拽鼠标选择矩形区域
   - 按Enter确认
   - 按Esc跳过

4. **掩膜格式**: 支持两种掩膜尺寸：
   - 原始参考图尺寸（会自动裁剪到公共区域）
   - 已裁剪尺寸（直接使用）

5. **文件路径**: 建议使用英文路径，避免中文路径可能导致的兼容性问题

## 故障排查

### 问题1: 点击批量处理没有反应
**解决方案**: 检查batch_thread.py和batch_config_dialog.py是否正确导入

### 问题2: 处理过程中出错
**解决方案**: 
- 查看信息框中的错误信息
- 检查输入目录是否包含有效图像
- 检查掩膜文件格式是否正确
- 确保有足够的磁盘空间

### 问题3: 进度不更新
**解决方案**: 
- 确保选择了有效的输入目录
- 检查文件权限
- 查看控制台是否有错误输出

## 依赖项

确保已安装以下Python包：

```bash
pip install PySide6
pip install numpy
pip install pandas
pip install opencv-python
pip install Pillow
pip install tifffile
pip install imgviz
pip install rich
pip install qt-material
```

## 版本信息

- **版本**: 1.0
- **日期**: 2025-11-04
- **兼容性**: Python 3.8+, PySide6

## 后续改进建议

1. 添加处理进度条
2. 支持批量选择多个掩膜文件
3. 添加预览功能，在处理前预览参数设置
4. 支持保存和加载配置文件
5. 添加历史记录功能
6. 支持拖拽文件/文件夹到界面

## 联系方式

如有问题或建议，请联系开发团队。
